name: Generate Changelog

on:
  schedule:
    - cron: '0 12 * * 1' # Roda toda segunda-feira 12h
  workflow_dispatch: # Permite rodar manualmente 

permissions:
  contents: write 

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Configure Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get All Pull Requests merged
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const since = new Date();
            since.setDate(since.getDate() - 7); //Last 7 days

            const pulls = await github.paginate(
              github.rest.pulls.list,
              {
                owner,
                repo,
                state: "closed",
                sort: "updated",
                direction: "desc"
              }
            );

            const mergedPRs = pulls
              .filter(pr => pr.merged_at && new Date(pr.merged_at) >= since)
              .map(pr => `- ${pr.title} (#${pr.number}) by @${pr.user.login}`);

            require("fs").writeFileSync("pr_changelog.md", mergedPRs.length ? mergedPRs.join("\n") : "No updates this week.");

      - name: Get Commits from last week
        run: |
          echo "# üÜï Changelog - $(date +'%d/%m/%Y')" > changelog.md
          echo "" >> changelog.md

          # Obter commits dos √∫ltimos 7 dias
          commits=$(git log --pretty=format:"- %s (%h) by %an" --since="1 week ago")

          # Categorizar commits
          echo "## üî• Novas Features" >> changelog.md
          echo "$commits" | grep -iE "(add|new|feature|create|implement|üöÄ)" || echo "Nenhuma nova funcionalidade." >> changelog.md
          echo "" >> changelog.md

          echo "## üõ† Altera√ß√µes" >> changelog.md
          echo "$commits" | grep -iE "(update|change|modify|refactor|üîÑ)" || echo "Nenhuma altera√ß√£o relevante." >> changelog.md
          echo "" >> changelog.md

          echo "## ‚ö†Ô∏è Quebras de Compatibilidade" >> changelog.md
          echo "$commits" | grep -iE "(remove|delete|break|incompatible|‚ùå)" || echo "Nenhuma quebra detectada." >> changelog.md
          echo "" >> changelog.md

          # Adicionar PRs ao changelog
          echo "## ‚úÖ Pull Requests Merged" >> changelog.md
          cat pr_changelog.md >> changelog.md
          echo "" >> changelog.md

          cat changelog.md
            require("fs").writeFileSync("pr_changelog.md", mergedPRs.length ? mergedPRs.join("\n") : "No updates this week.");

      - name: Get Commits from last week
        run: |
          echo "# üÜï Changelog - $(date +'%d/%m/%Y')" > changelog.md
          echo "" >> changelog.md

          # Obter commits dos √∫ltimos 7 dias
          commits=$(git log --pretty=format:"- %s (%h) by %an" --since="1 week ago")

          echo "## üõ† Altera√ß√µes" >> changelog.md
          echo "$commits" | grep -iE "(update|change|modify|refactor|üîÑ)" || echo "Nenhuma altera√ß√£o relevante." >> changelog.md
          echo "" >> changelog.md

          # Adicionar PRs ao changelog
          echo "## ‚úÖ Pull Requests Merged" >> changelog.md
          cat pr_changelog.md >> changelog.md
          echo "" >> changelog.md

          cat changelog.md

      - name: Commit and Push Changelog
        run: |
          git add changelog.md
          git commit -m "üìù Update Changelog"
          git branch -M master # Garante que est√° na branch correta
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
